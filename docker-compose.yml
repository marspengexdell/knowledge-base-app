# Docker Compose æ–‡ä»¶ç‰ˆæœ¬
version: '3.8'

# å®šä¹‰æ‰€æœ‰æœåŠ¡
services:
  # åç«¯æœåŠ¡ (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000" # å°†ä¸»æœºçš„ 8000 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 8000 ç«¯å£
    volumes:
      - ./backend/app:/app/app # å°†æœ¬åœ°çš„åç«¯ä»£ç æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œæ–¹ä¾¿çƒ­é‡è½½
    environment:
      - GRPC_SERVER_ADDRESS=inference:50051 # å‘ŠçŸ¥åç«¯å»è¿æ¥åä¸º'inference'çš„æœåŠ¡çš„50051ç«¯å£
      - VECTOR_DB_HOST=vector-db # å‘ŠçŸ¥åç«¯å‘é‡æ•°æ®åº“çš„ä¸»æœºå
      - VECTOR_DB_PORT=8000 # å‘ŠçŸ¥åç«¯å‘é‡æ•°æ®åº“çš„ç«¯å£
    depends_on: # ç¡®ä¿åœ¨åç«¯å¯åŠ¨å‰ï¼Œæ¨ç†æœåŠ¡å’Œå‘é‡æ•°æ®åº“å·²å¯åŠ¨
      - inference
      - vector-db
    networks: # å°†æœåŠ¡è¿æ¥åˆ°åŒä¸€ä¸ªç½‘ç»œ
      - app-network

  # ç”¨æˆ·å‰ç«¯æœåŠ¡ (Vue/React)
  frontend-user:
    build:
      context: ./frontend-user
      dockerfile: Dockerfile
    ports:
      - "8080:80" # å°†ä¸»æœºçš„ 8080 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 (nginx) ç«¯å£
    depends_on:
      - backend
    networks:
      - app-network

  # ç®¡ç†åå°å‰ç«¯æœåŠ¡ (Vue/React)
  frontend-admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
    ports:
      - "8081:80" # å°†ä¸»æœºçš„ 8081 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 (nginx) ç«¯å£
    depends_on:
      - backend
    networks:
      - app-network

  # æ¨ç†æœåŠ¡ (Llama.cpp)
  inference:
    build:
      context: ./inference
      dockerfile: Dockerfile
    volumes:
      # å°†æœ¬åœ°çš„ models ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /models ç›®å½•ï¼Œ'rw'ä»£è¡¨è¯»å†™æƒé™
      - ./models:/models:rw
      # å°†æˆ‘ä»¬æ–°åˆ›å»ºçš„é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œ'ro'ä»£è¡¨åªè¯»ï¼Œé˜²æ­¢ç¨‹åºæ„å¤–ä¿®æ”¹
      - ./inference/app/model_config.json:/app/model_config.json:ro
    
    # ------------------  ğŸ‘‡ GPU é…ç½® - è¿™æ˜¯å…³é”®ï¼ğŸ‘‡ ------------------
    # ä»¥ä¸‹é…ç½®ç”¨äºæˆæƒå®¹å™¨è®¿é—®ä¸»æœºçš„ NVIDIA GPU
    # ä½¿ç”¨å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ä¸»æœºå·²æ­£ç¡®å®‰è£… NVIDIA é©±åŠ¨å’Œ NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              # count: 1 ä»£è¡¨åˆ†é…ä¸€å— GPUã€‚å¦‚æœæƒ³ä½¿ç”¨æ‰€æœ‰ GPUï¼Œå¯ä»¥è®¾ç½®ä¸º 'all'
              count: 1
              # capabilities: [gpu] æ˜¯å¿…é¡»çš„ï¼Œå®ƒèµ‹äºˆå®¹å™¨ä½¿ç”¨ GPU çš„æ ¸å¿ƒæƒé™
              capabilities: [gpu]
    # ------------------  ğŸ‘† GPU é…ç½®ç»“æŸ ğŸ‘† ------------------
    networks:
      - app-network

  # å‘é‡æ•°æ®åº“æœåŠ¡ (ChromaDB)
  vector-db:
    image: chromadb/chroma
    ports:
      # å°†å®¹å™¨çš„ 8000 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 8001 ç«¯å£ï¼Œä»¥é¿å…ä¸åç«¯æœåŠ¡çš„ 8000 ç«¯å£å†²çª
      - "8001:8000"
    volumes:
      # å°†å‘é‡æ•°æ®åº“çš„æ•°æ®æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œé˜²æ­¢å®¹å™¨é‡å¯åæ•°æ®ä¸¢å¤±
      - chroma-data:/chroma/chroma
    networks:
      - app-network

# å®šä¹‰æ•°æ®å·ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨
volumes:
  chroma-data:

# å®šä¹‰è‡ªå®šä¹‰ç½‘ç»œï¼Œè®©æ‰€æœ‰æœåŠ¡å¯ä»¥äº’ç›¸é€šä¿¡
networks:
  app-network:
    driver: bridge