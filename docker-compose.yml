# docker-compose.yml (最终修正版)

services:
  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend/app:/app/app
    environment:
      # --- 这是唯一的、最关键的修正 ---
      # 将环境变量名从 GRPC_SERVER 改为 GRPC_SERVER_ADDRESS
      - GRPC_SERVER_ADDRESS=inference:50051
      - VECTOR_DB_HOST=vector-db
      - VECTOR_DB_PORT=8000
    depends_on:
      - inference
      - vector-db
    networks:
      - app-network

  # 用户前端服务
  frontend-user:
    build:
      context: ./frontend-user
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - backend
    networks:
      - app-network

  # 管理后台前端服务
  frontend-admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
    ports:
      - "8081:80"
    depends_on:
      - backend
    networks:
      - app-network

  # 推理服务
  inference:
    build:
      context: ./inference
      dockerfile: Dockerfile
    volumes:
      - ./models:/models:rw
      - ./inference/app/model_config.json:/app/model_config.json:ro
    # 您的 GPU 配置方式（完全有效，予以保留）
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    gpus: all
    networks:
      - app-network

  # 向量数据库服务
  vector-db:
    image: ghcr.io/chroma-core/chroma:latest
    ports:
      - "8001:8000"
    volumes:
      - chroma-data:/data
    networks:
      - app-network

volumes:
  chroma-data:

networks:
  app-network:
    driver: bridge